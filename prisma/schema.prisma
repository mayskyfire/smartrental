generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(STAFF)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum Role {
  ADMIN
  STAFF
  VIEWER
}

model Property {
  id          String    @id @default(cuid())
  name        String
  code        String    @unique
  address     String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  units       Unit[]
  invoices    Invoice[]
}

model Unit {
  id             String     @id @default(cuid())
  propertyId     String
  property       Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unitCode       String
  floor          Int?
  areaSqm        Float?
  baseRentAmount Float
  status         UnitStatus @default(VACANT)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  leases         Lease[]
  invoices       Invoice[]

  @@unique([propertyId, unitCode])
  @@index([propertyId])
  @@index([status])
}

enum UnitStatus {
  VACANT
  OCCUPIED
  INACTIVE
}

model Tenant {
  id              String           @id @default(cuid())
  fullName        String
  phone           String
  email           String?
  lineUserId      String?          @unique
  note            String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  leases          Lease[]
  lineMessageLogs LineMessageLog[]
}

model Lease {
  id                String      @id @default(cuid())
  tenantId          String
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unitId            String
  unit              Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  startDate         DateTime
  endDate           DateTime?
  monthlyRentAmount Float
  dueDayOfMonth     Int
  depositAmount     Float       @default(0)
  lateFeeStartDay   Int         @default(3)  // วันที่เริ่มคิดค่าปรับ (หลังครบกำหนด)
  dailyLateFee      Float       @default(100) // ค่าปรับรายวัน
  terminationDay    Int         @default(30) // วันที่ยกเลิกสัญญา (หลังครบกำหนด)
  status            LeaseStatus @default(ACTIVE)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  invoices          Invoice[]

  @@index([status])
  @@index([unitId])
  @@index([tenantId])
}

enum LeaseStatus {
  ACTIVE
  ENDED
  PAUSED
}

model Invoice {
  id                      String                  @id @default(cuid())
  leaseId                 String
  lease                   Lease                   @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  propertyId              String
  property                Property                @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unitId                  String
  unit                    Unit                    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  billingYear             Int
  billingMonth            Int
  billingPeriodStart      DateTime
  billingPeriodEnd        DateTime
  dueDate                 DateTime
  rentAmount              Float                   // ค่าเช่าพื้นฐาน
  lateFeeAmount           Float                   @default(0) // ค่าปรับที่คิด
  totalAmount             Float                   // รวมทั้งหมด
  paidAmount              Float                   @default(0)
  lateFeeStartDate        DateTime?               // วันที่เริ่มคิดค่าปรับ
  terminationDate         DateTime?               // วันที่จะยกเลิกสัญญา
  status                  InvoiceStatus           @default(PENDING)
  lineNotificationStatus  LineNotificationStatus  @default(NOT_SENT)
  lineLastError           String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  payments                Payment[]
  lineMessageLogs         LineMessageLog[]

  @@unique([leaseId, billingYear, billingMonth])
  @@index([propertyId])
  @@index([status])
  @@index([dueDate])
  @@index([billingYear, billingMonth])
}

enum InvoiceStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
}

enum LineNotificationStatus {
  NOT_SENT
  SENT
  FAILED
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  invoice   Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paidDate  DateTime
  amount    Float
  method    PaymentMethod @default(CASH)
  note      String?
  createdAt DateTime      @default(now())
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  PROMPTPAY
  OTHER
}

model LineMessageLog {
  id             String              @id @default(cuid())
  tenantId       String
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoiceId      String?
  invoice        Invoice?            @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  type           LineMessageType
  messageContent String
  sentAt         DateTime            @default(now())
  status         LineMessageStatus
  errorMessage   String?
}

enum LineMessageType {
  MONTHLY_REMINDER
  REMINDER_BEFORE_DUE
  ON_DUE_DATE
  OVERDUE
  MANUAL
}

enum LineMessageStatus {
  SUCCESS
  FAILED
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}
